@{
    ViewData["Title"] = "Robot Canlı İzleme";
    Layout = "_Layout";
    var kaynakId = (int?)ViewBag.KaynakId;
}

@section Head {
    <link rel="stylesheet" href="~/css/canli-izleme.css" />
    <style>
        /* Placeholder satırlar gri ve italik görünsün */
        #tbl-all-body tr.empty-row td { color:#9CA3AF; font-style:italic; }
        /* Sticky başlık için arkaplan */
        #tbl-all thead { position:sticky; top:0; background:#fff; z-index:1; }
    </style>
}

<div class="container-fluid py-4 page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card" style="background:linear-gradient(135deg,rgba(250,206,0,.95) 0%,rgba(240,151,1,.9) 50%,rgba(218,165,32,.95) 100%);border:1px solid rgba(240,151,1,.3);box-shadow:0 8px 32px rgba(240,151,1,.15);">
                <div class="card-body d-flex align-items-center justify-content-between py-4 px-4">
                    <div class="d-flex align-items-center">
                        <div class="me-4" style="width:60px;height:60px;background:var(--gradient-gold);border-radius:var(--radius-xl);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-gold);">
                            <i class="fas fa-robot" style="font-size:1.75rem;color:#1F2937;"></i>
                        </div>
                        <div>
                            <h3 class="mb-2" style="font-size:var(--font-size-3xl);font-weight:800;color:#111827;text-shadow:0 2px 4px rgba(0,0,0,.1);">
                                Robot Canlı İzleme
                            </h3>
                            <p class="mb-0" style="color:#6B7280;font-size:var(--font-size-lg);font-weight:500;">
                                <i class="fas fa-satellite-dish me-2" style="color:var(--gold-secondary);"></i>
                                Gerçek zamanlı kaynak verileri ve performans analizi
                            </p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        @if (kaynakId.HasValue)
                        {
                            <div class="badge-premium d-flex align-items-center gap-2">
                                <i class="fas fa-layer-group"></i>
                                <span style="font-weight:700;">Kaynak ID: @kaynakId.Value</span>
                            </div>
                        }
                        <div id="program-pill" class="d-flex align-items-center gap-3 px-3 py-2" style="background:rgba(250,252,251,.9);border-radius:var(--radius-lg);border:1px solid rgb(210,216,214);min-width:260px;">
                            <div id="program-status-dot" class="status-indicator inactive"></div>
                            <div class="d-flex flex-column" style="line-height:1.1;">
                                <span id="program-name" style="font-weight:600;font-size:var(--font-size-sm);color:#374151;">Program Yok</span>
                            </div>
                            <span id="program-state-label" class="ms-auto badge-premium" style="background:rgba(107,114,128,.15);color:#6B7280;font-weight:600;">BEKLEME</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metric Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-4">
            <div class="card metric-card h-100">
                <div class="card-body">
                    <div class="metric-icon" id="robot-icon-container" style="background:linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(16,185,129,.05) 100%);color:#10B981;">
                        <i class="fas fa-robot" style="font-size:1.75rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="metric-title">Robot Durumu</div>
                        <div class="metric-value" id="txt-status" style="color:#10B981;font-size:var(--font-size-lg);font-weight:400;">Sistem Hazır</div>
                        <div class="metric-subtitle mt-3 d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <span id="status-icon" class="status-indicator active me-2" style="width:10px;height:10px;"></span>
                                <span style="color:#9CA3AF;font-size:.8rem;font-weight:500;">Canlı Bağlantı</span>
                            </div>
                            <div style="color:#6B7280;font-size:.75rem;"><span id="last-upd" style="color:#374151;font-weight:600;">-</span></div>
                        </div>
                    </div>
                    <div class="ms-auto">
                        <div class="badge-premium" id="status-badge" style="background:rgba(16,185,129,.1);color:#10B981;">
                            <i class="fas fa-wifi me-1"></i>Canlı
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card metric-card h-100">
                <div class="card-body">
                    <div class="metric-icon" style="background:linear-gradient(135deg,rgba(240,151,1,.15) 0%,rgba(250,206,0,.05) 100%);color:var(--gold-secondary);">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="metric-title">Robot Hızı</div>
                        <div class="metric-value"><span id="val-speed" style="color:var(--gold-secondary);">0</span><small class="ms-1" style="color:#6B7280;font-size:var(--font-size-sm);font-weight:500;">mm/s</small></div>
                        <div class="metric-subtitle">Anlık hareket hızı</div>
                    </div>
                    <div class="ms-auto"><div class="badge-premium"><i class="fas fa-bolt me-1"></i>Anlık</div></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div id="system-status-card" class="card metric-card h-100" data-status="normal">
                <div class="card-body">
                    <div id="system-status-icon" class="metric-icon" style="background:linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(16,185,129,.05) 100%);color:#10B981;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="metric-title">Sistem Durumu</div>
                        <div class="metric-value"><span id="val-alarm" style="color:#10B981;font-weight:700;">Normal</span></div>
                        <div class="metric-subtitle"><span id="val-alarm-msg">Alarm bulunmuyor</span></div>
                    </div>
                    <div class="ms-auto"><div id="alarm-indicator" class="badge-premium" style="background:rgba(16,185,129,.1);color:#10B981;"><i class="fas fa-check-circle me-1"></i><span id="alarm-indicator-text">OK</span></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ TEK BİRLEŞİK TABLO -->
    <div class="card chart-card">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title m-0"><i class="fas fa-table me-2" style="color:var(--gold-secondary);"></i> Anlık Kaynak Değerleri</h5>
            <div class="badge-premium"><i class="fas fa-bolt me-1"></i>Gerçek Zamanlı</div>
        </div>
        <div class="card-footer p-0">
            <div class="table-responsive">
                <table class="table table-premium mb-0" id="tbl-all">
                    <thead>
                        <tr>
                            <th style="width:25%"><i class="fas fa-clock me-1" style="color:#6B7280;"></i>Zaman</th>
                            <th style="width:25%"><i class="fas fa-bolt me-1" style="color:#DC2626;"></i>Amper (A)</th>
                            <th style="width:25%"><i class="fas fa-plug me-1" style="color:#059669;"></i>Voltaj (V)</th>
                            <th style="width:25%"><i class="fas fa-wind me-1" style="color:var(--gold-secondary);"></i>Tel Hızı</th>
                        </tr>
                    </thead>
                    <tbody id="tbl-all-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft-signalr/8.0.0/signalr.min.js" asp-append-version="true"></script>
    <script>
        // ---------------- UI helpers ----------------
        function setProgramPill(running, programText) {
            const name = document.getElementById('program-name');
            const dot  = document.getElementById('program-status-dot');
            const lbl  = document.getElementById('program-state-label');
            if (running) {
                dot.classList.remove('inactive'); dot.classList.add('active'); dot.style.background = '#10B981';
                lbl.textContent = 'ÇALIŞIYOR'; lbl.style.background = 'rgba(16,185,129,.15)'; lbl.style.color = '#059669';
                name.textContent = (programText?.trim() || 'Program Bilgisi');
            } else {
                dot.classList.remove('active'); dot.classList.add('inactive'); dot.style.background = '#DC2626';
                lbl.textContent = 'BEKLEME'; lbl.style.background = 'rgba(107,114,128,.15)'; lbl.style.color = '#6B7280';
                name.textContent = 'Program Yok';
            }
        }

        function applyRobotStatusStyles(isRunning) {
            const txt = document.getElementById('txt-status');
            const ico = document.getElementById('status-icon');
            const box = document.getElementById('robot-icon-container');
            const badge = document.getElementById('status-badge');
            txt.textContent = isRunning ? 'Robot çalışıyor' : 'Robot durdu';
            txt.style.color = isRunning ? '#10B981' : '#DC2626';
            box.style.background = isRunning
                ? 'linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(16,185,129,.05) 100%)'
                : 'linear-gradient(135deg,rgba(220,38,38,.15) 0%,rgba(220,38,38,.05) 100%)';
            box.style.color = isRunning ? '#10B981' : '#DC2626';
            ico.style.background = isRunning ? '#10B981' : '#DC2626';
            ico.classList.toggle('active', isRunning);
            badge.style.background = isRunning ? 'rgba(16,185,129,.1)' : 'rgba(220,38,38,.1)';
            badge.style.color = isRunning ? '#10B981' : '#DC2626';
        }

        function fmtTime(iso) {
            const d = new Date(iso);
            return d.toLocaleTimeString('tr-TR', { hour12: false });
        }

        // --------------- Tablo helpers ----------------
        const MAX_TABLE_ROWS   = 20;
        const PLACEHOLDER_ROWS = 8;

        function renderEmptyRows(){
            const tb = document.getElementById('tbl-all-body');
            if(!tb) return;
            tb.innerHTML = '';
            for(let i=0;i<PLACEHOLDER_ROWS;i++){
                const tr = document.createElement('tr');
                tr.className = 'empty-row';
                tr.innerHTML = `<td>—</td><td>—</td><td>—</td><td>—</td>`;
                tb.appendChild(tr);
            }
        }

        function clearPlaceholders(){
            document.querySelectorAll('#tbl-all-body .empty-row')?.forEach(el=>el.remove());
        }

        function addUnifiedRow(time, amper, voltaj, tel){
            clearPlaceholders();
            const tb = document.getElementById('tbl-all-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${time}</td><td>${amper}</td><td>${voltaj}</td><td>${tel}</td>`;
            if (tb.firstChild) tb.insertBefore(tr, tb.firstChild); else tb.appendChild(tr);
            while (tb.children.length > MAX_TABLE_ROWS) tb.removeChild(tb.lastChild);
        }

        function resetLiveData(){
            const tb = document.getElementById('tbl-all-body');
            if (tb) tb.innerHTML = '';
            renderEmptyRows();
        }

        // --------------- İlk durum (API) ---------------
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/robot/status');
                if (res.ok) {
                    const data = await res.json();
                    const running = data.status === "Calisiyor";
                    setProgramPill(running, data.aktifProgram || '');
                    applyRobotStatusStyles(running);
                }
            } catch {}
            // Sayfa açılışında placeholder satırlarını çiz
            renderEmptyRows();
        });

        // ---------------- SignalR ----------------
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/robotStatusHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("ReceiveRobotStatus", (status, prog) => {
            const running = status === "Calisiyor";
            setProgramPill(running, prog);
            applyRobotStatusStyles(running);
            if (running) resetLiveData();
        });

        connection.on("ReceiveSystemStatus", (sysStatus) => {
            const isFault = (sysStatus === 'Fault');
            const card = document.getElementById('system-status-card');
            const icon = document.getElementById('system-status-icon');
            const val  = document.getElementById('val-alarm');
            const msg  = document.getElementById('val-alarm-msg');
            const bdg  = document.getElementById('alarm-indicator');
            card.setAttribute('data-status', isFault ? 'fault' : 'normal');
            icon.style.background = isFault ? 'linear-gradient(135deg,#dc2626,#b91c1c)' : 'linear-gradient(135deg,#059669,#10b981)';
            icon.style.color = '#fff';
            val.textContent = isFault ? 'Fault' : 'Normal';
            val.className = isFault ? 'mb-0 text-danger fw-bold' : 'mb-0 text-success fw-semibold';
            msg.textContent = isFault ? 'Hata alındı' : 'Alarm bulunmuyor';
            bdg.className = 'badge-premium d-inline-flex align-items-center gap-1';
            bdg.style.background = isFault ? 'linear-gradient(135deg,#dc2626,#ef4444)' : 'var(--gradient-gold)';
            bdg.style.color = isFault ? '#fff' : '#1F2937';
            bdg.innerHTML = isFault
                ? '<i class="fas fa-exclamation-triangle me-1"></i><span id="alarm-indicator-text">FAULT</span>'
                : '<i class="fas fa-check-circle me-1"></i><span id="alarm-indicator-text">OK</span>';
        });

        connection.on("ReceiveLiveData", (amper, voltaj, telSurmeHizi, zamanIso) => {
            const t = fmtTime(zamanIso);
            addUnifiedRow(t, amper, voltaj, telSurmeHizi);
        });

        connection.start().catch(console.error);
    </script>
}
