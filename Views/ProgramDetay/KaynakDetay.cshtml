@model FanucRelease.ViewModels.KaynakDetayVM
@using System.Text.Json

@{
    ViewData["Title"] = "Kaynak Detayı";

    // Toplam süre: ToplamSure 00:00:00 ise fallback => Bitis - Başlangıç
    string toplamSureText = Model.Kaynak.ToplamSure != default
        ? Model.Kaynak.ToplamSure.ToString("HH:mm:ss")
        : (Model.Kaynak.BitisSaati - Model.Kaynak.BaslangicSaati).ToString(@"hh\:mm\:ss");

    // Program bilgileri (nav null olsa bile ID güvenli)
    var programId  = Model.Kaynak.ProgramVerisi.Id;
    var programAdi = Model.Kaynak.ProgramVerisi?.ProgramAdi ?? $"Program #{programId}";

    // Chart verileri
    var labels = Model.Ornekler.Select(x => x.OlcumZamani.ToString("HH:mm:ss")).ToList();
    var voltaj = Model.Ornekler.Select(x => x.Voltaj).ToList();
    var amper  = Model.Ornekler.Select(x => x.Amper).ToList();
    var tel    = Model.Ornekler.Select(x => x.TelSurmeHizi).ToList();
    var hiz    = Model.Ornekler.Select(x => (double)x.KaynakHizi).ToList();

    var labelsJson = JsonSerializer.Serialize(labels);
    var voltajJson = JsonSerializer.Serialize(voltaj);
    var amperJson  = JsonSerializer.Serialize(amper);
    var telJson    = JsonSerializer.Serialize(tel);
    var hizJson    = JsonSerializer.Serialize(hiz);
}

@section Head {
    <link rel="stylesheet" href="~/css/performance.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <script src="~/libs/chart.js/Chart.min.js"></script>
}

<style>
/* Golden theme background for the page */
:root {
  --gold-start: #f09701;
  --gold-end: #face00;
  --gold-grad: linear-gradient(90deg, var(--gold-start), var(--gold-end));
  --gradient-primary: var(--gold-grad);
}

body {
  background: 
    radial-gradient(1200px 800px at 38% 35%, rgba(250,206,0,.95) 0%, rgba(240,151,1,.65) 34%, rgba(240,151,1,.25) 50%, rgba(21,18,10,0) 68%),
    radial-gradient(900px 600px at 88% 8%, rgba(240,151,1,.35) 0%, rgba(21,18,10,0) 60%),
    linear-gradient(180deg,#1c150a 0%, #15120a 100%);
  background-attachment: fixed;
  background-size: cover;
}

.content-area { background: transparent !important; }

/* Chart container styling for better integration */
canvas {
  border-radius: 8px;
}
</style>
<div class="container-fluid">

    <!-- Modern Header Section -->
    <div class="row align-items-center mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="stat-icon warning me-3" style="width: 60px; height: 60px; font-size: 1.5rem;">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div>
                        <h2 class="mb-0 text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,.25)">
                            Kaynak Detayı
                        </h2>
                        <p class="mb-0 text-white-50 small">
                            Program: <strong>@programAdi</strong> • Kaynak ID: <strong>@Model.Kaynak.Id</strong>
                        </p>
                    </div>
                </div>
                <a asp-action="Index" asp-route-id="@programId" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i> Programa Dön
                </a>
            </div>
        </div>
    </div>

    <!-- Zaman & Parametre kartları -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="gold-card p-4 h-100">
                <div class="d-flex align-items-center mb-3">
                    <div class="stat-icon info me-3" style="width: 45px; height: 45px; font-size: 1.1rem;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="section-card-title mb-0">Zaman Bilgileri</div>
                </div>
                <div>
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Başlangıç</dt>
                        <dd class="col-sm-7">@Model.Kaynak.BaslangicSaati.ToString("yyyy-MM-dd HH:mm:ss")</dd>

                        <dt class="col-sm-5">Bitiş</dt>
                        <dd class="col-sm-7">@Model.Kaynak.BitisSaati.ToString("yyyy-MM-dd HH:mm:ss")</dd>

                        <dt class="col-sm-5">Toplam Süre</dt>
                        <dd class="col-sm-7">@toplamSureText</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="gold-card p-4 h-100">
                <div class="d-flex align-items-center mb-3">
                    <div class="stat-icon primary me-3" style="width: 45px; height: 45px; font-size: 1.1rem;">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="section-card-title mb-0">Parametreler</div>
                </div>
                <div>
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Procedure No</dt>
                        <dd class="col-sm-7">@Model.Kaynak.PrcNo</dd>

                        <dt class="col-sm-5">Schedule No</dt>
                        <dd class="col-sm-7">@Model.Kaynak.SrcNo</dd>

                        <dt class="col-sm-5">Başlangıç Satırı</dt>
                        <dd class="col-sm-7">@Model.Kaynak.BaslangicSatiri</dd>

                        <dt class="col-sm-5">Bitiş Satırı</dt>
                        <dd class="col-sm-7">@Model.Kaynak.BitisSatiri</dd>

                        <dt class="col-sm-5">Kaynak Uzunluğu</dt>
                        <dd class="col-sm-7">@Model.Kaynak.KaynakUzunlugu</dd>

                        <dt class="col-sm-5">Program Id</dt>
                        <dd class="col-sm-7">@Model.Kaynak.ProgramVerisi?.Id</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Ortalama değerler - Modern Stat Cards -->
    <div class="stats-grid mb-4">
        <div class="stat-card primary">
            <div class="stat-header">
                <div class="stat-icon primary">
                    <i class="fas fa-bolt"></i>
                </div>
            </div>
            <div class="stat-value">@Model.OrtalamaVoltaj</div>
            <div class="stat-label">Ortalama Voltaj (V)</div>
        </div>
        <div class="stat-card success">
            <div class="stat-header">
                <div class="stat-icon success">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
            </div>
            <div class="stat-value">@Model.OrtalamaAmper</div>
            <div class="stat-label">Ortalama Amper (A)</div>
        </div>
        <div class="stat-card info">
            <div class="stat-header">
                <div class="stat-icon info">
                    <i class="fas fa-arrows-alt-h"></i>
                </div>
            </div>
            <div class="stat-value">@Model.OrtalamaTelSurme</div>
            <div class="stat-label">Ort. Tel Sürme (m/dk)</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-header">
                <div class="stat-icon warning">
                    <i class="fas fa-shipping-fast"></i>
                </div>
            </div>
            <div class="stat-value">@Model.OrtalamaKaynakHizi</div>
            <div class="stat-label">Ort. Kaynak Hızı (mm/s)</div>
        </div>
    </div>

    @if (!Model.Ornekler.Any())
    {
        <div class="gold-card p-4 text-center">
            <div class="stat-icon warning mx-auto mb-3">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h5 class="text-muted mb-2">Veri Bulunamadı</h5>
            <p class="text-muted mb-0">Bu kaynak için anlık ölçüm kaydı bulunmuyor.</p>
        </div>
    }
    else
    {
        <!-- Zaman serisi (Voltaj, Amper, Tel Sürme) -->
        <div class="gold-card p-4 mb-4">
            <div class="d-flex align-items-center mb-3">
                <div class="stat-icon primary me-3">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="section-card-title mb-0">Zaman Serisi — Voltaj / Amper / Tel Sürme</div>
            </div>
            <div style="height:320px">
                <canvas id="tsChart"></canvas>
            </div>
        </div>

        <!-- Zaman serisi (Kaynak Hızı) -->
        <div class="gold-card p-4 mb-4">
            <div class="d-flex align-items-center mb-3">
                <div class="stat-icon success me-3">
                    <i class="fas fa-chart-area"></i>
                </div>
                <div class="section-card-title mb-0">Zaman Serisi — Kaynak Hızı</div>
            </div>
            <div style="height:260px">
                <canvas id="speedChart"></canvas>
            </div>
        </div>

        <!-- Ortalama değerler bar chart + tablo -->
        <div class="gold-card p-4">
            <div class="d-flex align-items-center mb-3">
                <div class="stat-icon warning me-3">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="section-card-title mb-0">Ortalama Değerler</div>
            </div>
            <div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <div style="height:280px">
                            <canvas id="avgChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="gold-card p-3">
                            <table class="table table-sm mb-0">
                                <thead class="table-dark">
                                    <tr><th>Parametre</th><th>Ortalama</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><i class="fas fa-bolt me-2 text-primary"></i>Voltaj (V)</td><td><strong>@Model.OrtalamaVoltaj</strong></td></tr>
                                    <tr><td><i class="fas fa-tachometer-alt me-2 text-success"></i>Amper (A)</td><td><strong>@Model.OrtalamaAmper</strong></td></tr>
                                    <tr><td><i class="fas fa-arrows-alt-h me-2 text-info"></i>Tel Sürme (m/dk)</td><td><strong>@Model.OrtalamaTelSurme</strong></td></tr>
                                    <tr><td><i class="fas fa-shipping-fast me-2 text-warning"></i>Kaynak Hızı (mm/s)</td><td><strong>@Model.OrtalamaKaynakHizi</strong></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

@section Scripts{
    <script>
        const labels = @Html.Raw(labelsJson);
        const voltaj = @Html.Raw(voltajJson);
        const amper  = @Html.Raw(amperJson);
        const tel    = @Html.Raw(telJson);
        const hiz    = @Html.Raw(hizJson);

        // Zaman serisi: Voltaj / Amper / Tel Sürme
        if (labels.length > 0) {
            const ctx = document.getElementById('tsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { 
                            label: 'Voltaj (V)', 
                            data: voltaj, 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                            borderWidth: 3, 
                            pointRadius: 2, 
                            tension: 0.2,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#dc2626'
                        },
                        { 
                            label: 'Amper (A)', 
                            data: amper, 
                            borderColor: '#3b82f6', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                            borderWidth: 3, 
                            pointRadius: 2, 
                            tension: 0.2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#2563eb'
                        },
                        { 
                            label: 'Tel Sürme (m/dk)', 
                            data: tel, 
                            borderColor: '#10b981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                            borderWidth: 3, 
                            pointRadius: 2, 
                            tension: 0.2,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#059669'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Zaman', font: { size: 14, weight: 'bold' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        },
                        y: { 
                            title: { display: true, text: 'Değer', font: { size: 14, weight: 'bold' } }, 
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        }
                    }
                }
            });

            // Zaman serisi: Kaynak Hızı
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { 
                            label: 'Kaynak Hızı (mm/s)', 
                            data: hiz, 
                            borderColor: '#f59e0b', 
                            backgroundColor: 'rgba(245, 158, 11, 0.1)', 
                            borderWidth: 3, 
                            pointRadius: 3, 
                            tension: 0.2,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#d97706',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Zaman', font: { size: 14, weight: 'bold' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        },
                        y: { 
                            title: { display: true, text: 'mm/s', font: { size: 14, weight: 'bold' } }, 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Ortalama bar chart
        const avgCtx = document.getElementById('avgChart').getContext('2d');
        new Chart(avgCtx, {
            type: 'bar',
            data: {
                labels: ['Voltaj (V)', 'Amper (A)', 'Tel Sürme (m/dk)', 'Kaynak Hızı (mm/s)'],
                datasets: [{
                    label: 'Ortalama',
                    data: [@Model.OrtalamaVoltaj, @Model.OrtalamaAmper, @Model.OrtalamaTelSurme, @Model.OrtalamaKaynakHizi],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',   // Voltaj - Kırmızı
                        'rgba(59, 130, 246, 0.8)',  // Amper - Mavi
                        'rgba(16, 185, 129, 0.8)',  // Tel Sürme - Yeşil
                        'rgba(245, 158, 11, 0.8)'   // Kaynak Hızı - Turuncu
                    ],
                    borderColor: [
                        '#dc2626',  // Voltaj border
                        '#2563eb',  // Amper border
                        '#059669',  // Tel Sürme border
                        '#d97706'   // Kaynak Hızı border
                    ],
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(240, 151, 1, 0.5)',
                        borderWidth: 1
                    }
                },
                scales: { 
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#ffffff', font: { weight: 'bold' } }
                    },
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#ffffff', font: { weight: 'bold' } }
                    }
                }
            }
        });
    </script>
}
